package com.dereekb.gae.extras.gen.app.config.impl;

import java.util.List;
import java.util.Properties;

import com.dereekb.gae.extras.gen.app.config.app.AppConfiguration;
import com.dereekb.gae.extras.gen.app.config.app.services.remote.RemoteServiceConfiguration;
import com.dereekb.gae.extras.gen.utility.GenFile;
import com.dereekb.gae.extras.gen.utility.GenFolder;
import com.dereekb.gae.extras.gen.utility.impl.GenFolderImpl;
import com.dereekb.gae.extras.gen.utility.spring.SpringBeansXMLBuilder;

/**
 * {@link AbstractConfigurationFileGenerator} extension for files generated by
 * {@link RemoteServiceConfiguration} instances from the
 * {@link AppConfiguration}.
 *
 * @author dereekb
 *
 */
public abstract class AbstractRemoteServiceConfigurationGenerator extends AbstractConfigurationFileGenerator {

	private String resultsFolderName = "results";

	private boolean isSplitByService = true;
	private boolean makeImportFile = true;

	public AbstractRemoteServiceConfigurationGenerator(AppConfiguration appConfig) {
		this(appConfig, null);
	}

	public AbstractRemoteServiceConfigurationGenerator(AppConfiguration appConfig, Properties outputProperties) {
		super(appConfig, outputProperties);
	}

	public String getResultsFolderName() {
		return this.resultsFolderName;
	}

	public void setResultsFolderName(String resultsFolderName) {
		if (resultsFolderName == null) {
			throw new IllegalArgumentException("resultsFolderName cannot be null.");
		}

		this.resultsFolderName = resultsFolderName;
	}

	public boolean isSplitByService() {
		return this.isSplitByService;
	}

	public void setSplitByService(boolean isSplitByService) {
		this.isSplitByService = isSplitByService;
	}

	public boolean isMakeImportFile() {
		return this.makeImportFile;
	}

	public void setMakeImportFile(boolean makeImportFile) {
		this.makeImportFile = makeImportFile;
	}

	// MARK: AbstractConfigurationFileGenerator
	@Override
	public GenFolderImpl generateConfigurations() {
		return this.makeModelClientConfigurations();
	}

	private final GenFolderImpl makeModelClientConfigurations() {
		return this.makeGeneratorForConfiguration().makeServiceConfigurations(this.getAppConfig().getRemoteServices());
	}

	public RemoteServiceClientConfigurationGenerator makeGeneratorForConfiguration() {
		if (this.isSplitByService) {
			return new SplitByRemoteServiceClientConfigurationGenerator();
		} else {
			return new TogetherRemoteServiceClientConfigurationGenerator();
		}
	}

	public final GenFolderImpl makeConfigurationsForService(RemoteServiceConfiguration service) {
		if (this.shouldMakeConfigurationForService(service)) {
			return this.makeServiceConfiguration(service);
		} else {
			return null;
		}
	}

	protected boolean shouldMakeConfigurationForService(RemoteServiceConfiguration service) {
		return true;
	}

	public GenFolderImpl makeServiceConfiguration(RemoteServiceConfiguration service) {
		GenFolderImpl folder = new GenFolderImpl(
		        service.getAppServiceConfigurationInfo().getAppServiceName().toLowerCase());
		this.makeServiceConfiguration(folder, service);
		return folder;
	}

	/**
	 * Override this if the implementation should make a folder of configuration
	 * per service.
	 */
	public void makeServiceConfiguration(GenFolderImpl serviceResultsFolder,
	                                     RemoteServiceConfiguration service) {
		GenFile file = this.makeServiceConfigurationFile(service);
		serviceResultsFolder.addFile(file);
	}

	/**
	 * Override this for convenience if the implementation only creates a single
	 * file that doesn't return XML.
	 */
	public GenFile makeServiceConfigurationFile(RemoteServiceConfiguration service)
	        throws UnsupportedOperationException {
		SpringBeansXMLBuilder builder = this.makeXMLServiceConfigurationFile(service);
		String fileName = service.getAppServiceConfigurationInfo().getAppServiceName().toLowerCase();
		return this.makeFileWithXML(fileName, builder);
	}

	/**
	 * Override this for convenience if the implementation only creates a single
	 * file.
	 *
	 * @throws UnsupportedOperationException
	 *             thrown by default if not overridden.
	 */
	public SpringBeansXMLBuilder makeXMLServiceConfigurationFile(RemoteServiceConfiguration service)
	        throws UnsupportedOperationException {
		throw new UnsupportedOperationException("Override in subclass to use.");
	}

	// MARK: Generator
	public interface RemoteServiceClientConfigurationGenerator {

		public GenFolderImpl makeServiceConfigurations(List<RemoteServiceConfiguration> services);

	}

	public class SplitByRemoteServiceClientConfigurationGenerator
	        implements RemoteServiceClientConfigurationGenerator {

		@Override
		public GenFolderImpl makeServiceConfigurations(List<RemoteServiceConfiguration> services) {
			GenFolderImpl folder = new GenFolderImpl(
			        AbstractRemoteServiceConfigurationGenerator.this.resultsFolderName);

			for (RemoteServiceConfiguration service : services) {
				GenFolder serviceFolder = makeConfigurationsForService(service);

				if (serviceFolder != null) {
					folder.addFolder(serviceFolder);
				}
			}

			if (AbstractRemoteServiceConfigurationGenerator.this.makeImportFile) {
				GenFile importFile = makeImportFile(folder, true, true);
				folder.addFile(importFile);
			}

			return folder;
		}

	}

	public class TogetherRemoteServiceClientConfigurationGenerator
	        implements RemoteServiceClientConfigurationGenerator {

		@Override
		public GenFolderImpl makeServiceConfigurations(List<RemoteServiceConfiguration> services) {
			GenFolderImpl folder = new GenFolderImpl(
			        AbstractRemoteServiceConfigurationGenerator.this.resultsFolderName);

			for (RemoteServiceConfiguration service : services) {
				GenFolder serviceFolder = makeConfigurationsForService(service);

				if (serviceFolder != null) {
					folder.merge(serviceFolder);
				}
			}

			return folder;
		}

	}
}
